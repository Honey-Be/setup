#!/usr/bin/env python

import alpm, os, sys
from optparse import OptionParser

# since we're not in chroot, we need up to date libs. but don't be too
# agressive, we add libs to here just in case there was a bugreport about it
# parted: #807
libs = ['parted', 'pacman-g2']
packages = ['bash', 'kernel', 'busybox', 'dhcpcd', 'dialog', 'e2fsprogs',
		'eject', 'frugalware', 'glibc', 'kbd', 'module-init-tools',
		'ncurses', 'netkit-base', 'reiserfsprogs', 'udev',
		'util-linux', 'mdadm', 'xfsprogs', 'ppp', 'rp-pppoe', 'glib2',
		'bzip2', 'libarchive', 'zlib', 'frugalwareutils',
		'wireless_tools', 'ipw2200-firmware', 'dropbear', 'bastet',
		'readline', 'acx100', 'shadow', 'madwifi', 'rt2500']

# when releasing a new setup, please update this :)
version = "0.7.0"

# parse our options
parser = OptionParser(version="configure for Frugalware Setup v%s" % (version))
parser.set_defaults(debug=False)
parser.set_defaults(repo="current")
parser.add_option("--enable-debug", action="store_true", dest="debug", help="Build setup with debug options")
parser.add_option("--disable-debug", action="store_false", dest="debug", help="Build setup without debug options")
parser.add_option("--repo", action="store", dest="repo", help="Select the repo to build for. Can be current (default), testing or stable")
(options, args) = parser.parse_args()

# if we want debug then we should add gdb and it's dependencies
sys.stdout.write("checking for debug support... ")
sys.stdout.flush()
if options.debug:
	sys.stdout.write("yes.\n")
	sys.stdout.flush()
	packages.append('gdb')
	packages.append('expat')
else:
	sys.stdout.write("no.\n")
	sys.stdout.flush()

def pkgGetVers(db, names, ret={}):
	lp = alpm.db_getpkgcache(db)
	while lp:
		pkg = alpm.void_to_PM_PKG(alpm.list_getdata(lp))
		pkgname = alpm.void_to_char(alpm.pkg_getinfo(pkg, alpm.PKG_NAME))
		if pkgname in names and pkgname not in ret:
			ret[pkgname] = pkgname = alpm.void_to_char(alpm.pkg_getinfo(pkg, alpm.PKG_VERSION))
		lp = alpm.list_next(lp)
	return ret

try:
	os.unlink('config.mak')
except OSError:
	pass

if alpm.initialize("/") == -1:
	raise "failed to init the alpm lib"

remote = alpm.db_register("frugalware-current")
local = alpm.db_register("local")
sys.stdout.write("reading the remote database... ")
sys.stdout.flush()
remotevers = pkgGetVers(remote, libs)
sys.stdout.write("done.\nreading the local database... ")
sys.stdout.flush()
localvers = pkgGetVers(local, libs)
sys.stdout.write("done.\n")
sys.stdout.flush()

for k, v in remotevers.items():
	sys.stdout.write("checking for host %s... " % k)
	if remotevers[k] != localvers[k]:
		sys.stdout.write("failed, please do a 'pacman-g2 -S %s'\n" % k)
		sys.exit(1)
	else:
		sys.stdout.write("done.\n")

remotevers = pkgGetVers(remote, packages, remotevers)
socket = open("config.mak", "w")

# write out our required options
socket.write("VERSION = %s\n" % version)
if options.debug:
	socket.write("DEBUG = true\n\n")
else:
	socket.write("DEBUG = false\n\n")

# check whether stable or testing was requested
sys.stdout.write("checking which repo to build for... ")
sys.stdout.flush()
if options.repo == "current":
	sys.stdout.write("current\n")
	socket.write("STABLE = false\nTESTING = false\n\n")
elif options.repo == "testing":
	sys.stdout.write("testing\n")
	socket.write("STABLE = false\nTESTING = true\n\n")
elif options.repo == "stable":
	sys.stdout.write("stable\n")
	socket.write("STABLE = true\nTESTING = false\n\n")
else:
	sys.stdout.write("invalid repo specified!\n")
	sys.exit(1)

# write the package versions
for k, v in localvers.items():
	print "checking for %s... %s" % (k, v)
	socket.write("%sVER = %s\n" % (k.upper(), v))
socket.write("\n")

# write the package and source arrays
socket.write("packages = \\\n")
for k, v in localvers.items():
	socket.write("\t   %s \\\n" % k)
socket.write("\t   \n")

socket.write("sources = \\\n")
for k, v in localvers.items():
	socket.write("\t  %s-$(%sVER)-$(CARCH).fpm \\\n" % (k, k.upper()))
socket.write("\t  \n")

socket.close()
